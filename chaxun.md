# 课程位置查询系统需求文档

## 1. 项目背景
为了快速响应客户查询附近课程的需求，需要开发一个简单的查询工具。客户通过微信发送地址，工作人员需要快速查询并返回距离该地址最近的课程信息。

## 2. 用户需求
### 2.1 主要用户
- 课程顾问（使用此工具查询并回复客户）
- 合作伙伴（需要分享工具给他们使用）

### 2.2 使用场景
- 主要在手机端操作
- 少部分在电脑端操作
- 通过微信进行客户沟通

## 3. 功能需求
### 3.1 核心功能
1. 地址查询
   - 输入框接收地址信息
   - 自动获取地址的经纬度
   - 计算与所有课程地点的距离
   - 查询模式：
     * 地址查询模式：输入地址，显示最近的5个课程（含距离和时间信息）
     * 纯筛选模式：不输入地址，显示最多20个符合条件的课程
   - 课程筛选功能：
     * 行政区筛选（例如：静安区、徐汇区等）
     * 班型筛选（私教/团课）
     * 课程类型筛选（吉他、非洲鼓等）
   - 筛选实现：
     * 从课程名称中提取相关信息
     * 提供三个独立的下拉选择框
     * 支持多条件组合筛选
     * 支持重置筛选条件

2. 城市切换
   - 右上角城市选择器
   - 切换城市时自动更新：
     * 清空当前结果
     * 重新加载该城市的筛选选项
   - 所有查询都基于当前选中城市

3. 结果展示
   - 显示最近的5个课程
   - 每个课程显示：
     * 课程名称
     * 具体地址
     * 直线距离（仅地址查询模式）
     * 交通信息（仅地址查询模式）：
       - 表格中显示：
         > 驾车预计时间
         > 公交预计时间
       - 提供"查看路线"功能，包含：
         > 驾车路线：
            · 全程距离和时间
            · 主要道路信息
            · 转弯和路口提示
         > 公交路线：
            · 起始步行信息（距离和时间）
            · 地铁换乘信息（线路、站数、时间）
            · 终点步行信息（距离和时间）
       - 支持一键复制路线详情

4. 分享功能
   - 文本复制：格式化的课程信息
   - 图片生成：表格样式的查询结果
   - 路线复制：详细的交通路线信息（驾车/公交）

3. 数据结构
   - 课程名称格式解析：
     * 示例：【私教】静安静安寺-吉他-8节
   - 字段解析：
     * 班型（筛选字段）：私教、3人团等
     * 行政区（筛选字段）：从地址中提取
     * 课程类型（筛选字段）：吉他、非洲鼓等
     * 其他信息：课时等

3. 结果处理
   - 一键复制功能
   - 格式化的输出文本

### 3.2 技术需求
1. 数据处理
   - 课程数据从Excel文件读取（课程名称、具体地址两列）
   - 地址经纬度信息缓存
   - 避免重复地址多次查询
   - 数据规模：数百条课程记录
   - 更新频率：低频更新
   - 数据文件规范：
     * 命名格式：{城市}课表汇总_{日期}.xlsx
     * 示例：上海课表汇总_20240111.xlsx
     * 必需字段：课程、具体地址、城市
     * 生成文件：{城市}课表经纬度_{日期}.xlsx
   - 优化策略：
     * 相同地址的课程只查询一次经纬度
     * 已有经纬度的地址不重复查询
     * 将查询结果保存到Excel中复用
     * 添加API调用频率控制（每秒最多2次请求）
     * 实现本地缓存，减少重复查询
     * 批量查询时添加适当延时

2. 接口调用
   - 高德地图API
     * 地理编码（地址转经纬度）
     * 路径规划（驾车和公交）

## 4. 非功能需求
### 4.1 性能需求
- 页面加载时间 < 3秒
- 查询响应时间 < 5秒
- 支持多人同时使用

### 4.2 可用性需求
- 移动端友好的界面
- 简单直观的操作流程
- 清晰的结果展示格式

### 4.3 部署需求
- 使用免费的云服务部署
- 易于维护和更新
- 无需安装额外软件
- 访问控制：
  * 考虑添加简单密码保护
  * 记录基本访问日志
- 预期访问量：
  * 日访问量：几十次
  * 并发要求：低

## 5. 实现方案
### 5.1 技术栈
- 前端：HTML + CSS + JavaScript
- 后端：Python Flask
- 数据存储：Excel文件
- 部署平台：Vercel/Railway

### 5.2 系统架构
1. 前端页面
   - 移动端响应式设计
   - 简单的表单交互
   - 结果展示区域

2. 后端服务
   - 数据加载和缓存
   - 地址解析和距离计算
   - API接口封装

### 5.3 数据流程
1. 初始化
   - 加载课程数据
   - 缓存已有经纬度信息

2. 查询流程
   - 接收地址输入
   - 解析地址获取经纬度
   - 计算距离并排序
   - 返回格式化结果

## 6. 项目规划
### 6.1 开发阶段
1. 第一阶段：基础功能实现
   - 搭建Web框架
   - 实现地址查询
   - 实现结果展示

2. 第二阶段：优化和测试
   - 移动端适配
   - 性能优化
   - 功能测试

### 6.2 后续规划
- 添加用户反馈收集
- 优化查询效率
- 考虑添加地图展示功能

## 7. 注意事项
- 确保高德地图API密钥的正确配置
- 注意API调用频率限制
- API使用注意事项：
  * 查询高德API配额限制
  * 实现本地缓存机制减少API调用
  * 考虑添加请求频率控制
- 定期备份课程数据
- 保持代码的可维护性

## 8. 多城市支持
### 8.1 数据管理
- 每个城市独立的Excel文件
- 统一的字段格式
- 文件命名规范

### 8.2 查询逻辑
- 基于城市筛选课程
- 城市级别的地址验证
- 城市特定的路线规划

### 8.3 后续扩展
- 支持城市切换
- 跨城市数据整合
- 城市特定的配置（如API参数）

## 部署说明

### 本地部署（开发环境）
```bash
# 1. 安装依赖
pip install flask pandas requests

# 2. 运行应用
python app.py
```

### Vercel 部署（免费生产环境）
适合小规模使用（几个用户），完全免费，包含以下优势：
- 自动 HTTPS
- 全球 CDN
- 持续部署

部署步骤：
```bash
# 1. 安装 Vercel CLI
npm install -g vercel

# 2. 项目结构调整
/your-project
   ├── api/              # Serverless 函数目录
   │   └── index.py      # 主函数
   ├── public/           # 静态文件
   │   └── index.html
   ├── requirements.txt  # Python 依赖
   └── vercel.json       # 配置文件

# 3. 部署命令
vercel
```

### 其他免费部署选项
1. **Railway.app**
   - 提供免费额度
   - 直接支持 Python/Flask
   - 可以直接从 GitHub 部署

2. **Render.com**
   - 提供免费的 Web 服务
   - 支持 Python 应用
   - 每月有免费额度

## 部署注意事项
1. 确保高德 API 密钥配置正确
2. 数据文件的存储和更新方式
3. 必要的安全措施（HTTPS、访问限制等）
4. 定期备份数据

## 部署进展

### 当前完成进度
1. 项目结构调整
   - [x] 创建 Vercel 项目结构
   - [x] 调整目录布局
   - [x] 移动文件到正确位置

2. 文件准备
   - [x] 创建 requirements.txt
   - [x] 创建 vercel.json
   - [x] 修改 api/index.py
   - [x] 移动数据文件到 public/data/

3. 当前目录结构
```
课表/
├── api/
│   └── index.py          # Vercel 函数入口
├── public/
│   ├── data/
│   │   └── 上海课表经纬度_20250111.xlsx  # 数据文件
│   └── index.html       # 前端页面
├── app.py               # 本地开发服务器
├── prepare_data.py      # 数据处理脚本
├── chaxun.md           # 需求文档
├── README.md           # 项目说明
├── requirements.txt    # 依赖配置
└── vercel.json         # Vercel 配置
```

### 待完成任务
1. Vercel 部署
   - [ ] 安装 Vercel CLI (npm install -g vercel)
   - [ ] 登录 Vercel (vercel login)
   - [ ] 部署项目 (vercel)

2. 部署后配置
   - [ ] 检查数据文件访问
   - [ ] 验证 API 功能
   - [ ] 确认高德地图 API 可用性

3. 测试计划
   - [ ] 测试地址查询功能
   - [ ] 测试筛选功能
   - [ ] 测试路线查询
   - [ ] 测试图片生成

### 部署注意事项
1. 确保数据文件正确放置在 public/data 目录
2. 验证高德地图 API 密钥在生产环境可用
3. 检查所有路径引用是否正确
4. 确保依赖包版本兼容

### 后续计划
1. 完成 Vercel 部署
2. 进行功能测试
3. 添加访问控制（如需要）
4. 建立数据更新机制

### 常用命令
```bash
# 本地开发
python app.py

# Vercel 部署
vercel

# 更新已部署的项目
vercel --prod
```

### 相关链接
- Vercel 控制台: https://vercel.com/dashboard
- 项目文档: README.md
- 高德地图 API: https://lbs.amap.com/api/webservice/guide/api/georegeo
